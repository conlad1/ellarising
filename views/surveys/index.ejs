<%- include('../partials/header', { title: 'Surveys â€“ Admin', currentUser, currentPath: '/surveys' }) %>

<section class="section">
  <div class="section-header header-with-actions">
    <div>
      <h1 class="section-title">Surveys</h1>
      <p class="section-subtitle">
        Feedback from participants about Ella Rises events.
      </p>
    </div>

    <% if (currentUser && currentUser.role === 'admin') { %>
      <a href="/surveys/new" class="btn btn-primary">Record Survey</a>
    <% } %>
  </div>

  <form method="GET" class="filters filters-inline" id="surveysFilterForm">
    <div class="form-group">
      <label for="q">Search</label>
      <input id="q" name="q" type="text" value="<%= q || '' %>" placeholder="Search by participant or event">
    </div>
    <div class="form-group">
      <label for="event">Event</label>
      <select id="event" name="event">
        <option value="">All Events</option>
        <% if (eventNames && eventNames.length > 0) { %>
          <% eventNames.forEach(eventName => { %>
            <option value="<%= eventName %>" <%= (eventFilter === eventName) ? 'selected' : '' %>><%= eventName %></option>
          <% }) %>
        <% } %>
      </select>
    </div>
    <% if (q || eventFilter) { %>
      <div class="form-group">
        <a href="/surveys" class="btn btn-text">Clear</a>
      </div>
    <% } %>
  </form>

<script>
  // Auto-submit form when event dropdown changes
  document.addEventListener('DOMContentLoaded', function() {
    const eventSelect = document.getElementById('event');
    const filterForm = document.getElementById('surveysFilterForm');
    
    if (eventSelect && filterForm) {
      eventSelect.addEventListener('change', function() {
        filterForm.submit();
      });
    }
  });
</script>

  <% if (!surveys || surveys.length === 0) { %>
    <p>No surveys recorded yet.</p>
  <% } else { %>
    <div class="table-container">
      <table class="table">
      <thead>
        <tr>
          <th>Participant</th>
          <th>Event</th>
          <th>Submitted</th>
          <th>Satisfaction</th>
          <th>Usefulness</th>
          <th>Recommend</th>
          <th class="table-actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% surveys.forEach(s => { %>
          <tr>
            <td><%= s.participantName %></td>
            <td><%= s.eventName %></td>
            <td><%= s.submitted_at %></td>
            <td><%= s.satisfaction || '-' %></td>
            <td><%= s.usefulness || '-' %></td>
            <td><%= s.recommend || '-' %></td>
            <td class="table-actions">
              <a href="/surveys/<%= s.id %>" class="link-small">View/edit record details</a>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
    </div>
  <% } %>
</section>

<%- include('../partials/footer') %>