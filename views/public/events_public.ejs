<%- include('../partials/header', { title: 'Events – Ella Rises', currentUser, currentPath: '/events' }) %>

<style>
  .events-schedule {
    max-width: 960px;
    margin: 0 auto;
  }

  .schedule-day {
    margin-bottom: 2rem;
    border-left: 3px solid #e0e0e0;
    padding-left: 1.5rem;
    position: relative;
  }

  .schedule-day::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 0;
    width: 13px;
    height: 13px;
    border-radius: 50%;
    background: #f06292;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #f06292;
  }

  .day-header {
    margin-bottom: 1rem;
  }

  .day-date {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
  }

  .day-label {
    font-size: 0.85rem;
    color: #777;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .event-item {
    background: #fff;
    border-radius: 16px;
    border: 1px solid #e5e5e5;
    padding: 1rem 1.25rem;
    margin-bottom: 1rem;
    display: flex;
    flex-direction: row; /* text left, image right */
    justify-content: space-between;
    gap: 1rem;
    transition: box-shadow 0.15s ease, transform 0.1s ease;
  }

  .event-item:hover {
    box-shadow: 0 4px 14px rgba(0,0,0,0.06);
    transform: translateY(-1px);
  }

  .event-content {
    flex: 1 1 auto;
  }

  .event-image-wrap {
    flex: 0 0 160px;
    display: flex;
    justify-content: flex-end;
  }

  .event-image {
    width: 160px;
    height: 110px;
    border-radius: 12px;
    object-fit: cover;
    margin-left: 12px;
  }

  .event-time {
    font-size: 0.9rem;
    font-weight: 600;
    color: #f06292;
    margin-bottom: 0.35rem;
  }

  .event-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0 0 0.4rem 0;
    color: #333;
  }

  .event-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.5rem;
  }

  .event-meta-item strong {
    font-weight: 600;
  }

  .event-description {
    font-size: 0.95rem;
    color: #555;
    margin: 0;
  }

  .filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
    gap: 1rem;
    margin-bottom: 2.25rem;
  }

  .filters .form-group label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: #888;
  }

  .filters .form-group input,
  .filters .form-group select {
    margin-top: 0.35rem;
  }

  @media (max-width: 768px) {
    .schedule-day {
      padding-left: 1rem;
    }

    .event-item {
      flex-direction: column;        /* stack on mobile */
    }

    .event-image-wrap {
      justify-content: center;
    }

    .event-image {
      width: 100%;
      height: 180px;
      margin-left: 0;
      margin-top: 0.5rem;
    }
  }
</style>

<section class="section">
  <div class="section-header">
    <h1 class="section-title">Upcoming Events</h1>
    <p class="section-subtitle">
      Join us at upcoming workshops, summits, and performances.
    </p>
  </div>

  <% if (!events || events.length === 0) { %>
    <p>No upcoming events yet. Check back soon!</p>
  <% } else { %>

    <!-- Pass events to JS as JSON -->
    <script id="eventsData" type="application/json">
      <%- JSON.stringify(events || []) %>
    </script>

    <!-- Filters -->
    <form class="filters filters-grid" id="eventsFilter">
      <div class="form-group">
        <label for="searchEvents">Search</label>
        <input id="searchEvents" type="text" placeholder="Search events...">
      </div>
      <div class="form-group">
        <label for="filterType">Event Type</label>
        <select id="filterType">
          <option value="">All Types</option>
        </select>
      </div>
      <div class="form-group">
        <label for="filterLocation">Location</label>
        <select id="filterLocation">
          <option value="">All Locations</option>
        </select>
      </div>
      <div class="form-group">
        <label for="filterTime">Time of Day</label>
        <select id="filterTime">
          <option value="">All Times</option>
          <option value="morning">Morning (6am–12pm)</option>
          <option value="afternoon">Afternoon (12pm–5pm)</option>
          <option value="evening">Evening (5pm–9pm)</option>
          <option value="night">Night (9pm–12am)</option>
        </select>
      </div>
    </form>

    <div id="noResults" style="display:none;">
      <p>No events match your filters.</p>
    </div>

    <div class="events-schedule" id="eventsContainer"></div>

  <% } %>
</section>

<script>
  (function () {
    const dataTag = document.getElementById('eventsData');
    if (!dataTag) return;

    const rawEvents = JSON.parse(dataTag.textContent || '[]');
    const eventsContainer = document.getElementById('eventsContainer');
    const noResults = document.getElementById('noResults');
    const searchInput = document.getElementById('searchEvents');
    const typeFilter = document.getElementById('filterType');
    const locationFilter = document.getElementById('filterLocation');
    const timeFilter = document.getElementById('filterTime');

    function formatDateInfo(dt) {
      if (!dt) return null;
      const d = new Date(dt);
      return {
        raw: d,
        dateKey: d.toISOString().split('T')[0],
        displayDate: d.toLocaleDateString('en-US', {
          weekday: 'long',
          month: 'long',
          day: 'numeric',
          year: 'numeric'
        }),
        time: d.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        }),
        hour: d.getHours()
      };
    }

    const events = rawEvents.map(ev => {
      const di = formatDateInfo(ev.dateTime);
      return {
        ...ev,
        dateInfo: di,
        dateKey: di ? di.dateKey : 'TBD'
      };
    }).sort((a, b) => {
      if (!a.dateInfo) return 1;
      if (!b.dateInfo) return -1;
      return a.dateInfo.raw - b.dateInfo.raw;
    });

    // populate filter dropdowns
    const types = [...new Set(events.map(e => e.type).filter(Boolean))].sort();
    const locations = [...new Set(events.map(e => e.location).filter(Boolean))].sort();

    types.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      typeFilter.appendChild(opt);
    });

    locations.forEach(l => {
      const opt = document.createElement('option');
      opt.value = l;
      opt.textContent = l;
      locationFilter.appendChild(opt);
    });

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    // map type -> image path
    function getEventImage(type) {
      const t = (type || '').toLowerCase();
      if (t.includes('annual')) return '/images/annual_conference.jpg';
      if (t.includes('art')) return '/images/arts.jpg';
      if (t.includes('leader')) return '/images/leadership.jpg';
      if (t.includes('stem') || t.includes('steam')) return '/images/steam.jpg';
      return '';
    }

    function timeOfDay(hour) {
      if (hour == null) return '';
      if (hour >= 6 && hour < 12) return 'morning';
      if (hour >= 12 && hour < 17) return 'afternoon';
      if (hour >= 17 && hour < 21) return 'evening';
      return 'night';
    }

    function groupByDate(list) {
      const map = {};
      list.forEach(ev => {
        const key = ev.dateKey || 'TBD';
        if (!map[key]) map[key] = [];
        map[key].push(ev);
      });
      return map;
    }

    function render(list) {
      if (!list.length) {
        eventsContainer.innerHTML = '';
        noResults.style.display = 'block';
        return;
      }
      noResults.style.display = 'none';

      const grouped = groupByDate(list);
      const keys = Object.keys(grouped).sort((a, b) => {
        if (a === 'TBD') return 1;
        if (b === 'TBD') return -1;
        return new Date(a) - new Date(b);
      });

      let html = '';
      keys.forEach(dateKey => {
        const dayEvents = grouped[dateKey];
        const first = dayEvents[0];
        const displayDate = first.dateInfo
          ? first.dateInfo.displayDate
          : 'Date To Be Determined';

        html += `
          <div class="schedule-day">
            <div class="day-header">
              <div class="day-date">${escapeHtml(displayDate)}</div>
              <div class="day-label">${dayEvents.length} ${dayEvents.length === 1 ? 'Event' : 'Events'}</div>
            </div>
        `;

        dayEvents.forEach(ev => {
          const di = ev.dateInfo;
          const time = di ? di.time : 'Time TBD';
          const imgSrc = getEventImage(ev.type);
          const imgHtml = imgSrc
            ? `
              <div class="event-image-wrap">
                <img src="${imgSrc}" alt="${escapeHtml(ev.type)} event" class="event-image">
              </div>
            `
            : '';

          html += `
            <div class="event-item">
              <div class="event-content">
                <div class="event-time">${time}</div>
                <h3 class="event-title">${escapeHtml(ev.name)}</h3>
                <div class="event-meta">
                  <span class="event-meta-item">
                    <strong>Type:</strong> ${escapeHtml(ev.type || 'TBD')}
                  </span>
                  <span class="event-meta-item">
                    <strong>Location:</strong> ${escapeHtml(ev.location || 'TBD')}
                  </span>
                </div>
                ${ev.description
                  ? `<p class="event-description">${escapeHtml(ev.description)}</p>`
                  : ''}
              </div>
              ${imgHtml}
            </div>
          `;
        });

        html += '</div>';
      });

      eventsContainer.innerHTML = html;
    }

    function applyFilters() {
      const q = (searchInput.value || '').toLowerCase();
      const typeVal = (typeFilter.value || '').toLowerCase();
      const locVal = (locationFilter.value || '').toLowerCase();
      const timeVal = (timeFilter.value || '').toLowerCase();

      const filtered = events.filter(ev => {
        const name = (ev.name || '').toLowerCase();
        const type = (ev.type || '').toLowerCase();
        const loc = (ev.location || '').toLowerCase();
        const desc = (ev.description || '').toLowerCase();
        const tod = ev.dateInfo ? timeOfDay(ev.dateInfo.hour) : '';

        const matchesSearch =
          !q ||
          name.includes(q) ||
          type.includes(q) ||
          loc.includes(q) ||
          desc.includes(q);

        const matchesType = !typeVal || type === typeVal;
        const matchesLoc = !locVal || loc === locVal;
        const matchesTime = !timeVal || tod === timeVal;

        return matchesSearch && matchesType && matchesLoc && matchesTime;
      });

      render(filtered);
    }

    // initial render
    render(events);

    // listeners
    searchInput.addEventListener('input', applyFilters);
    typeFilter.addEventListener('change', applyFilters);
    locationFilter.addEventListener('change', applyFilters);
    timeFilter.addEventListener('change', applyFilters);
  })();
</script>

<%- include('../partials/footer') %>